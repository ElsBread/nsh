<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<body>
    <h1>你好</h1>
    <div style="background: rgba(255,255,255,0.1); padding: 10px; color: white; text-align: right;">
    <span>目前登入：<strong id="user-display">載入中...</strong></span>
    <button onclick="handleLogout()" style="margin-left: 10px; padding: 5px 15px; border-radius: 15px; cursor: pointer; background: #ff4b2b; color: white; border: none;">
        登出
    </button>
</div>
</body>

<script>
    // 1. 初始化 (請確保 SB_KEY 是完整長度的那個)
    const SB_URL = 'https://ofuxzhfeqvihcgiucopx.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mdXh6aGZlcXZpaGNnaXVjb3B4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQ4ODEsImV4cCI6MjA4MzA0MDg4MX0.pYDTBag5NgmUFxOzABWIytnMtUv-QloY31JYZaoZrmk-n';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // 2. 判定登入狀態的主函數
    async function checkLoginStatus() {
        // 先檢查 LocalStorage 做初步判斷 (速度快)
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        
        // 向 Supabase 伺服器確認 Session 是否真的有效
        const { data: { session }, error } = await _supabase.auth.getSession();

        if (!isLoggedIn || !session) {
            // 如果沒登入或 Session 過期，踢回登入頁
            console.log("未登入，跳轉中...");
            window.location.href = "auth.html";
        } else {
            // 登入成功，可以取得使用者資訊
            const userEmail = session.user.email;
            const username = userEmail.split('@')[0]; // 把 @gmail.com 削掉
            
            console.log("歡迎回來:", username);
            
            // 如果你有個 ID 叫 'user-display' 的元素，可以顯示名字
            if(document.getElementById('user-display')) {
                document.getElementById('user-display').textContent = username;
            }
        }
    }

    // 3. 登出函數
    async function handleLogout() {
        await _supabase.auth.signOut();
        localStorage.removeItem('isLoggedIn');
        window.location.href = "auth.html";
    }

    // 執行檢查
    checkLoginStatus();
</script>
